name: QA

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]

jobs:
  qa:
    runs-on: ubuntu-latest

    env:
      DATABASE_PASSWORD: ${{ secrets.DATABASE_PASSWORD }}
      DATABASE_HOST: localhost
      DATABASE_USER: ${{ vars.DATABASE_USER }}
      DATABASE_NAME: ${{ vars.DATABASE_NAME }}

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: ${{ env.DATABASE_PASSWORD }}
          MYSQL_DATABASE: ${{ vars.DATABASE_NAME }}
          MYSQL_USER: ${{ vars.DATABASE_USER }}
          MYSQL_PASSWORD: ${{ env.DATABASE_PASSWORD }}
        ports:
          - 3306:3306
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3

      pgsql:
        image: postgres:15
        env:
          POSTGRES_DB: ${{ vars.DATABASE_NAME }}
          POSTGRES_USER: ${{ vars.DATABASE_USER }}
          POSTGRES_PASSWORD: ${{ env.DATABASE_PASSWORD }}
        ports:
          - 5432:5432
        options: --health-cmd pg_isready --health-interval 10s --health-timeout 5s --health-retries 3

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.4'
          extensions: pdo, pdo_mysql, pdo_pgsql, pdo_sqlite
          tools: composer:v2

      - name: Install dependencies
        run: composer install --no-progress --prefer-dist --optimize-autoloader

      - name: Create .env file
        run: |
          cat > .env << EOF
          DATABASE_HOST=${{ vars.DATABASE_HOST }}
          DATABASE_USER=${{ vars.DATABASE_USER }}
          DATABASE_PASSWORD=${{ env.DATABASE_PASSWORD }}
          DATABASE_NAME=${{ vars.DATABASE_NAME }}
          EOF

      - name: Wait for MySQL to be ready
        run: |
          for i in {1..30}; do
            if mysqladmin ping -h"127.0.0.1" -uroot -p"${{ env.DATABASE_PASSWORD }}" --silent 2>/dev/null; then
              echo "MySQL is ready"
              break
            fi
            echo "Waiting for MySQL... ($i/30)"
            sleep 2
          done

      - name: 'Debug: Check database connectivity'
        run: |
          echo "ğŸ” Checking database connectivity..."
          echo "DATABASE_HOST: ${{ vars.DATABASE_HOST }}"
          echo "DATABASE_USER: ${{ vars.DATABASE_USER }}"
          echo "DATABASE_NAME: ${{ vars.DATABASE_NAME }}"

          # Check MySQL connectivity
          echo "Testing MySQL connection..."
          if php -r "
            try {
              \$pdo = new PDO('mysql:host=127.0.0.1;port=3306;dbname=${{ vars.DATABASE_NAME }}', '${{ vars.DATABASE_USER }}', '${{ env.DATABASE_PASSWORD }}');
              echo 'âœ… MySQL connection successful';
            } catch (Exception \$e) {
              echo 'âŒ MySQL connection failed: ' . \$e->getMessage();
              exit(1);
            }
          "; then
            echo "âœ… PHP can connect to MySQL"
          else
            echo "âŒ PHP cannot connect to MySQL"
            exit 1
          fi

          # Check PostgreSQL connectivity
          echo "Testing PostgreSQL connection..."
          if php -r "
            try {
              \$pdo = new PDO('pgsql:host=127.0.0.1;port=5432;dbname=${{ vars.DATABASE_NAME }}', '${{ vars.DATABASE_USER }}', '${{ env.DATABASE_PASSWORD }}');
              echo 'âœ… PostgreSQL connection successful';
            } catch (Exception \$e) {
              echo 'âŒ PostgreSQL connection failed: ' . \$e->getMessage();
              exit(1);
            }
          "; then
            echo "âœ… PHP can connect to PostgreSQL"
          else
            echo "âŒ PHP cannot connect to PostgreSQL"
            exit 1
          fi

          echo "ğŸ‰ All database connections verified!"

      - name: Run QA checks
        run: composer qa
